<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Google Login Example</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 24px; }
    .container { max-width: 720px; margin: 0 auto; }
    .card { border: 1px solid #ddd; padding: 16px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .profile { display: flex; gap: 12px; align-items: center; }
    .profile img { width: 72px; height: 72px; border-radius: 50%; }
    .meta { display: flex; flex-direction: column; }
    .actions { margin-top: 12px; }
    #g_id_onload { display:none; }
  </style>
</head>
<body>
  <header style="padding:18px 24px 6px 24px;">
    <h1 style="margin:0; font-size:48px; font-weight:600;">Sign In With Google</h1>
  </header>

  <main style="display:flex; align-items:center; justify-content:center; height:70vh;">
    <div style="width:620px; height:360px; border:2px solid #111; box-shadow: 0 0 0 8px rgba(0,0,0,0.06); display:flex; align-items:center; justify-content:center;">
      <div style="width:420px; height:220px; background:#fff; border-radius:6px; box-shadow:0 4px 18px rgba(0,0,0,0.08); display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div style="text-align:center; color:#333; margin-bottom:14px;">
          <h2 style="margin:0; font-size:18px; font-weight:600;">Welcome Back</h2>
          <p style="margin:6px 0 0 0; font-size:13px; color:#666;">Please sign in to continue</p>
        </div>

        <div id="button-container" style="display:flex; align-items:center; justify-content:center; width:100%;"></div>

        <div class="actions" style="margin-top:8px;">
          <button id="signout-btn" style="display:none">Sign out</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    // Replace this with your Client ID or pass it via ?client_id=...
    const CLIENT_ID = '7458319065-7s4n1ujqvo8vaes5jl76jnl0q4os29cj.apps.googleusercontent.com';

    function getClientIdFromUrl() {
      try {
        const params = new URLSearchParams(window.location.search);
        return params.get('client_id') || '';
      } catch (e) {
        return '';
      }
    }

    const clientId = CLIENT_ID || getClientIdFromUrl();

    if (!clientId) {
      const el = document.getElementById('button-container');
      el.innerHTML = '<p style="color:crimson">No Client ID provided. Add your Client ID to the <code>CLIENT_ID</code> constant in the file or pass it as <code>?client_id=YOUR_CLIENT_ID</code> in the URL.</p>';
    }

    // Parse JWT payload helper
    function parseJwt (token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    let tokenResponse = null;

    function handleCredentialResponse(response) {
      // response.credential is the ID token (JWT)
      tokenResponse = response;
      const payload = parseJwt(response.credential);
      if (!payload) return;

      // Update UI if present (guard against missing elements)
      try {
        const pName = document.getElementById('profile-name');
        if (pName) pName.textContent = payload.name || payload.email;
        const pEmail = document.getElementById('profile-email');
        if (pEmail) pEmail.textContent = payload.email || '';
        const pPic = document.getElementById('profile-pic');
        if (pPic) pPic.src = payload.picture || '';
        const pBox = document.getElementById('profile');
        if (pBox) pBox.style.display = 'flex';
        const sBtn = document.getElementById('signout-btn');
        if (sBtn) sBtn.style.display = 'inline-block';
        const tDbg = document.getElementById('token-debug');
        if (tDbg) { tDbg.style.display = 'block'; tDbg.textContent = JSON.stringify(payload, null, 2); }
      } catch (e) {
        // ignore UI errors
      }

      // Save profile to sessionStorage for other pages to read
      try { sessionStorage.setItem('g_profile', JSON.stringify(payload)); } catch (e) { /* ignore */ }

      // Robust redirect: try to navigate to the requested hash first, then fallback to direct file.
      (function redirectToPeriodic() {
        const hashTarget = 'css3d_periodictable.html#file:css3d_periodictable.html';
        try {
          // try assign (better than href in some cases)
          window.location.assign(hashTarget);
        } catch (e) {
          try { window.location.href = hashTarget; } catch (e2) { /* ignore */ }
        }
      })();
    }

    function initializeGsi() {
      if (!clientId) return;

      window.google.accounts.id.initialize({
        client_id: clientId,
        callback: handleCredentialResponse
      });

      // Render the button into the container
      window.google.accounts.id.renderButton(
        document.getElementById('button-container'),
          { theme: 'outline', size: 'large', width: '280' }  // customization attributes
      );

      // Optional: prompt the One Tap UX
      // window.google.accounts.id.prompt();
    }

    document.getElementById('signout-btn').addEventListener('click', () => {
      // To sign out, remove the token from memory and call revoke if you want
      if (tokenResponse && tokenResponse.credential) {
        // Revoke the token via Google's revoke endpoint
        const url = 'https://oauth2.googleapis.com/revoke?token=' + encodeURIComponent(tokenResponse.credential);
        fetch(url, { method: 'POST', headers: { 'Content-type': 'application/x-www-form-urlencoded' } })
          .catch(() => {});
      }

      tokenResponse = null;
      document.getElementById('profile').style.display = 'none';
      document.getElementById('signout-btn').style.display = 'none';
      document.getElementById('token-debug').style.display = 'none';
    });

    // Initialize when library is loaded
    function tryInit() {
      if (window.google && window.google.accounts && window.google.accounts.id) {
        initializeGsi();
      } else {
        // retry once the script has loaded; the external script is deferred/async
        setTimeout(tryInit, 200);
      }
    }

    tryInit();
  </script>
</body>
</html>
